---
title: "Bayesian analysis (Grade 6-10)"
author: "Michael Wu"
date: "2023-05-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load cleaned data files
```{r}
#load("/Users/michaelfive/Library/CloudStorage/GoogleDrive-wuzezhen33@gmail.com/My Drive/Nepal SA Study/Analysis/model/gr6-10_survey_gpa_1015.RData")
```

# Data preparation

```{r data preparation, include = F}
library(tidyverse)
library(targets)
library(brms)
library(mice)
library(bayestestR)
library(performance)
library(broom.mixed)
library(lme4)
library(bayesplot)
library(interactions)
library(rstanarm)

source("R/functions.R")

# stan option
options(mc.cores = parallel::detectCores())

# reversed coded master dataset
# dat <- tar_read(dat_all_cleaned_reverse_coded)

# combine coded master dataset
dat_t <- tar_read(dat_all_cleaned_combine_coded)

# combine coded master dataset with fscores
dat_fs <- tar_read(dat_all_cleaned_combine_coded_fscore)
```

# Handling Missingness

```{r}
dat_s <- dat_fs |> 
  filter(!is.na(treated_int)) |> 
  filter(grade %in% c(6:10))

# scale within each classroom
dat_s <- dat_s |> 
  group_by(class_id) |> 
  mutate_at(vars(fscore_f1_b:fscore_f3_e), function(x){as.numeric(scale(x))})

# exclude the raw survey items to prevent double-dipping in multiple imputation
dat_s <- dat_s |> select(
  st_id, sch_id, grade, class_id, class_size, gender, age_b, student_type, father_edu_f,
  mother_edu_f, father_occ_salary, mother_occ_salary, adult_members,
  siblings, treated_int, duration_int, 
  int_q1_value_1_int, int_q1_value_2_int, int_q1_value_3_int,
  ind_count_int, inter_count_int, total_count_int,
  mc_survey_1_int:mc_survey_4_int,
  nepali_scores_b:science_grades_b,
  nepali_scores_e:science_grades_e,
  fscore_f1_b:fscore_f3_e)

dat_s$all_gpa_b <- rowMeans(dat_s[,c("nepali_gpa_b", "english_gpa_b", "math_gpa_b", "science_gpa_b")], na.rm = T)
dat_s$all_gpa_e <- rowMeans(dat_s[,c("nepali_gpa_e", "english_gpa_e", "math_gpa_e", "science_gpa_e")], na.rm = T)

# dat_s <- dat_s |> 
#   filter(!(sch_id == 3 & grade == 12)) |> 
#   filter(!(sch_id == 2 & grade %in% c(11, 12))) |> 
#   filter(!(sch_id == 1 & grade %in% c(11, 12)))

# qualitative codes
tar_load(qual_code_cleaned)
dat_s <- dat_s |> left_join(qual_code_cleaned, by = "st_id")

# subset data for different treatment groups
dat_treated <- dat_s |> filter(treated_int == 1)
dat_control <- dat_s |> filter(treated_int == 0)

```

```{r, include = F}
dat_s_mi <- dat_s |> select(
  st_id, sch_id, grade, class_id, class_size, gender, age_b, student_type, father_edu_f,
  mother_edu_f, father_occ_salary, mother_occ_salary, adult_members,
  siblings, treated_int, duration_int,
  int_q1_value_1_int, int_q1_value_2_int, int_q1_value_3_int,
  mc_survey_1_int:mc_survey_4_int,
  # nepali_gpa_b, english_gpa_b, math_gpa_b, science_gpa_b,
  # nepali_gpa_e, english_gpa_e, math_gpa_e, science_gpa_e,
  all_gpa_b, all_gpa_e,
  fscore_f1_b:fscore_f3_e)

dat_mi <- mice::mice(dat_s_mi, m = 5, seed = 1234)

# x <- complete(dat_mi)
# View(x)

# Jakobsen et al. BMC Medical Research Methodology (2017) 17:162
test <- dat_s |> select(fscore_f1_b, fscore_f1_e, treated_int ,
      class_size , grade , gender , age_b , student_type ,
      #father_edu_f , mother_edu_f ,
      father_occ_salary , mother_occ_salary , adult_members , siblings , duration_int , sch_id)

mice::md.pattern(test,rotate.names = T)

# percentage of complete cases (GPA, three survey outcomes): 0.651 0.591 0.591 0.591
round(c(175, 159, 159, 159)/(nrow(dat_s)),3)

# quite many missingness occurred due to students not knowing father's or mother's education, after removing these two variables: 0.907 0.825 0.825 0.825
round(c(244, 222, 222, 222)/(nrow(dat_s)),3)

```

```{r}
# Tests the null hypothesis that the missing data is Missing Completely At Random (MCAR). A p.value of less than 0.05 is usually interpreted as being that the missing data is not MCAR (i.e., is either Missing At Random or non-ignorable).

test <- dat_s |> select(
      st_id, all_gpa_e, all_gpa_b, fscore_f1_b, fscore_f1_e, fscore_f2_b, fscore_f2_e, fscore_f3_b, fscore_f3_e, treated_int, class_size, grade, gender, age_b, 
      father_edu_f, mother_edu_f, 
      father_occ_salary, mother_occ_salary, adult_members, siblings, duration_int)

#   statistic    df p.value missing.patterns
#       <dbl> <dbl>   <dbl>            <int>
# 1      183.   173   0.288               12
naniar::mcar_test(test)


mice::md.pattern(test, rotate.names = T)
# We believe the missing data is MCAR, because we know the missingness has random and distinct reasons.

# 32 missing all endline survey data because they were not in school during the data collection for non-academic reasons
# 10 missing GPA either because they did not take the exam or school record entry errors
# 1 missing both survey and GPA
# 1 missing baseline age potentially due to entry error
# 1 + 6 missing all baseline data because no presence during data collection
# 1 + 1 missing all baseline and endline data because no presence during data collection
# 3 missing intervention data because of no presence during data collection
# 3 missing intervention and endline because of no presence during data collection

# So it seems reasonable to conduct complete-cases analysis.
```

# Descriptive statistics
```{r}
length(unique(dat_s$st_id))
table(dat_s$sch_id)
table(dat_s$sch_id, dat_s$grade, dat_s$treated_int)

prop.table(table(dat_s$gender))
prop.table(table(dat_s$grade))

mean(dat_s$age_b, na.rm = T)
sd(dat_s$age_b, na.rm = T)

table(dat_s$treated_int)

table(dat_s$student_type)

df <- dat_s |> select(
      st_id, sch_id, all_gpa_e, all_gpa_b, treated_int, class_size, grade, gender, age_b, 
      father_edu_f, mother_edu_f, 
      father_occ_salary, mother_occ_salary, adult_members, siblings, duration_int) |> 
  na.omit() |> 
  group_by(sch_id, treated_int) |> 
  summarise(
    m_e = mean(all_gpa_e, na.rm = T),
    sd_e = sd(all_gpa_e, na.rm = T),
    m_b = mean(all_gpa_b, na.rm = T),
    sd_b = sd(all_gpa_b, na.rm = T),
    n = n()
  ); df

# Reshape the data
df_long <- df %>%
  gather(key = "time", value = "score", c(m_b, m_e)) %>%
  gather(key = "sd_time", value = "sd", c(sd_b, sd_e)) %>%
  mutate(time = ifelse(time == "m_b", "Baseline", "Endline"),
         treated_int = ifelse(treated_int == 0, "Control", "Treatment"),
         sch_id = recode(sch_id, `1` = "Baglung", `2` = "Kathmandu", `3` = "Pokhara"),
         se = sd/sqrt(n)) %>%
  filter((time == "Baseline" & sd_time == "sd_b") | (time == "Endline" & sd_time == "sd_e")) 

# Define dodge width
dodge <- position_dodge(width=0.2)

# Plot the data
ggplot(df_long, aes(x = time, y = score, color = treated_int, group = treated_int)) +
  geom_line(position = dodge) +
  geom_point(position = dodge) +
  geom_errorbar(aes(ymin = score - se, ymax = score + se), width = 0.2, position = dodge) +
  facet_wrap(~ sch_id) +
  scale_x_discrete(labels = c("Baseline", "Endline")) +
  scale_color_discrete(labels = c("Control", "Treatment")) +
  labs(color = "",
       x = "\nTime",
       y = "GPA\n") +
  theme_bw()


df <- dat_s |> select(
      st_id, sch_id, fscore_f1_e, fscore_f1_b, fscore_f2_e, fscore_f2_b, fscore_f3_e, fscore_f3_b, treated_int, class_size, grade, gender, age_b, 
      father_edu_f, mother_edu_f, 
      father_occ_salary, mother_occ_salary, adult_members, siblings, duration_int) |> 
  na.omit() |> 
  group_by(sch_id, treated_int) |> 
  summarise(
    m_f1_e = mean(fscore_f1_e, na.rm = T),
    sd_f1_e = sd(fscore_f1_e, na.rm = T),
    m_f1_b = mean(fscore_f1_b, na.rm = T),
    sd_f1_b = sd(fscore_f1_b, na.rm = T),
    m_f2_e = mean(fscore_f2_e, na.rm = T),
    sd_f2_e = sd(fscore_f2_e, na.rm = T),
    m_f2_b = mean(fscore_f2_b, na.rm = T),
    sd_f2_b = sd(fscore_f2_b, na.rm = T),
    m_f3_e = mean(fscore_f3_e, na.rm = T),
    sd_f3_e = sd(fscore_f3_e, na.rm = T),
    m_f3_b = mean(fscore_f3_b, na.rm = T),
    sd_f3_b = sd(fscore_f3_b, na.rm = T),
    n = n()
  ); df

dat_s |> group_by(sch_id) |> reframe(m = mean(all_gpa_e, na.rm = T))

dat_s |> group_by(sch_id) |> reframe(m = mean(all_gpa_b, na.rm = T))

mean(dat_s$all_gpa_b, na.rm = T)
mean(dat_s$all_gpa_e, na.rm = T)

mean(dat_s$all_gpa_b < 2.4, na.rm = T)
mean(dat_s$all_gpa_e < 2.4, na.rm = T)

dat_s |> group_by(sch_id) |> reframe(
  m1 = mean(all_gpa_b < 2.4, na.rm = T),
  m1 = mean(all_gpa_b < 2, na.rm = T)
)

sd(dat_s$all_gpa_b, na.rm = T)
sd(dat_s$all_gpa_e, na.rm = T)
mean(dat_s$fscore_f1_b, na.rm = T)
mean(dat_s$fscore_f2_b, na.rm = T)
mean(dat_s$fscore_f3_b, na.rm = T)
mean(dat_s$fscore_f1_e, na.rm = T)
mean(dat_s$fscore_f2_e, na.rm = T)
mean(dat_s$fscore_f3_e, na.rm = T)

```


```{r}
df <- dat_s |> 
  group_by(treated_int, class_id) |>
  mutate(class_id = as.numeric(class_id)) |> 
  summarise(m_b = mean(all_gpa_b, na.rm = T),
            se_b = sd(all_gpa_b, na.rm = T)/sqrt(length(all_gpa_b)),
            m_e = mean(all_gpa_e, na.rm = T),
            se_e = sd(all_gpa_e, na.rm = T)/sqrt(length(all_gpa_e))
            )

df <- df |> 
  pivot_longer(cols = m_b:se_e,
               names_to = c("stat", "time"),
               names_pattern = "(.*)_(.*)",
               values_to = "value")

df <- df |> 
  pivot_wider(names_from = "stat", values_from = "value")

df <- df |> 
  mutate(treated_int = ifelse(treated_int == 1,
                              "Treatment",
                              "Control")
         # sch_id = case_when(
         #   sch_id == 1 ~ "Baglung",
         #   sch_id == 2 ~ "Kathmandu",
         #   sch_id == 3 ~ "Pokhara")
         )  |> 
  mutate(class_id = case_when(
           class_id %in% c(1:5) ~ paste0("School A Grade ", class_id + 5),
           class_id %in% c(8:12) ~ paste0("School B Grade ", class_id - 2),
           class_id %in% c(15:19) ~ paste0("School C Grade ", class_id - 9)
         )) |> 
  mutate(class_id = factor(class_id,
                           levels = c(
                             paste0("School A Grade ", 6:10),
                             paste0("School B Grade ", 6:10),
                             paste0("School C Grade ", 6:10)
                           ))) |> 
  rename(Condition = treated_int)

df <- df |> 
  mutate(time = ifelse(time == "b", "Baseline", "Endline"))

ggplot(data = df,
       aes(x = time, y = m, group = Condition,
           color = Condition)) +
  geom_line(position=position_dodge(0.2))+
  geom_point(size = 2, position=position_dodge(0.2)) +
  geom_errorbar(aes(ymin=m-se, ymax=m+se), width=.2,
                 position=position_dodge(0.2)) +
  labs(x = "", y = "GPA\n",
       title = "Average GPA at Baseline and Endline\nby Treatment Conditions and Classes\n",
       caption = "(Each error bar shows the standard error of the group mean.)") +
  facet_wrap(~class_id, nrow = 3) +
  theme_minimal() +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
   scale_color_manual(values=c('firebrick1','steelblue1')) + 
  ylim(c(1,3.5))

```

```{r}
# correlation matrix
cor_df <- corstarsl(dat_s |> ungroup() |> select(fscore_f1_b:fscore_f3_b, all_gpa_b,
                                                 fscore_f1_e:fscore_f3_e, all_gpa_e))

rownames(cor_df) <- c("1. Self-integrity and Belonging in School (Baseline)",
                      "2. Stereotype Threat (Baseline)",
                      "3. Academic Stress (Baseline)",
                      "4. Grade Point Average (Baseline)",
                      "5. Self-integrity and Belonging in School (Endline)",
                      "6. Stereotype Threat (Endline)",
                      "7. Academic Stress (Endline)",
                      "8. Grade Point Average (Endline)")

colnames(cor_df) <- as.character(c(1:8))

write.csv(cor_df, "analysis/tables/tab_cor.csv")
```

# Differential Attrition

```{r}
temp <- dat_s |> mutate(has_gpa_e = !is.na(all_gpa_e))

mod_attr <- stan_glm(has_gpa_e ~ treated_int * (age_b + gender), data = temp, family = "binomial", seed = 1234)

summary(mod_attr, digits = 3)
```

# Analysis

## Prior predictive checks

```{r check priors}
# priors to be tested
my_prior <- prior("normal(0, 1)", class = "b")

# my_prior_pos <- prior("normal(0, 1)", class = "b") +
#     prior("normal(0.145, 0.2175)", class = "b", coef = "treated_int")
# 
# my_prior_neg <- prior("normal(0, 1)", class = "b") +
#     prior("normal(-0.145, 0.2175)", class = "b", coef = "treated_int")

# check default priors for other parameters
validate_prior(
    my_prior,
    fscore_f1_e ~ fscore_f1_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_s)
```

## Primary outcomes

```{r}
# test <- dat_s |> 
#   ungroup() |> 
#   mutate(father_edu_f = as.character(father_edu_f),
#          mother_edu_f = as.character(mother_edu_f)) |> 
#   mutate(father_edu_f = ifelse(is.na(father_edu_f), "Don't know", father_edu_f)) |> 
#   mutate(mother_edu_f = ifelse(is.na(mother_edu_f), "Don't know", mother_edu_f))

fit_gpa <- brm(
    all_gpa_e ~ all_gpa_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )


fit_math <- brm(
    math_gpa_e ~ math_gpa_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

fit_science <- brm(
    science_gpa_e ~ science_gpa_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

fit_nepali <- brm(
    nepali_gpa_e ~ nepali_gpa_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

fit_english <- brm(
    english_gpa_e ~ english_gpa_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )


```

```{r}
# posterior predictive checks suggest pretty good fit
p1 <- pp_check(fit_gpa, ndraws = 200) +
  labs(title = "Posterior predictive checking for the model\npredicting GPA", 
       x = "GPA", 
       y = "Density") + 
  xlim(-5,5) +
  theme_classic();p1

# loo suggests good predictive performance (not necessary though if I wish to focusing on interpreting the model parameters)
loo_gpa <- loo(fit_gpa, reloo = T)
```

```{r}
hypothesis(fit_gpa, "treated_int > 0")
# hypothesis(fit_math, "treated_int > 0") *
# hypothesis(fit_science, "treated_int > 0")
# hypothesis(fit_nepali, "treated_int > 0")
# hypothesis(fit_english, "treated_int > 0")

# posterior predictive plots
draws <- as_draws_df(fit_gpa)

plot.kdensity(draws$b_treated_int, value = 0,
              xlab = "Estimated Difference (Treatment - Control)",
              main = "Posterior Distribution of the Treatment Effect of\n Values Affirmation on Nepalese Deaf Students' GPA",
              col1 = "steelblue1",
              col2 = "firebrick1")

# Add ROPE: a shaded rectangle between the lines
rect(-sd(dat_s$all_gpa_e, na.rm = T) * 0.02,
     0, 
     sd(dat_s$all_gpa_e, na.rm = T) * 0.02,
     16, col = rgb(1, 0.5, 0, alpha = 0.5), border = NA)



# 95% high-density interval for reporting
hdi(fit_gpa, ci = 0.89)

# posterior draws of Cohen's d effect size
summary(get.posterior.treat.d(fit_gpa))

# Sequential Effect eXistence and sIgnificance Testing (SEXIT) framework
# using the empirical benchmark in Kraft (2020)
sexit(fit_gpa, significant = 0.02 * sd(dat_s$all_gpa_e, na.rm = T), large = 0.05 * sd(dat_s$all_gpa_e, na.rm = T), ci = 0.89)[3,]

# consider es = 0.01 as negligible
rope(fit_gpa, ci = 0.89, 
     range = c(-sd(dat_s$all_gpa_e, na.rm = T) * 0.02, 
               sd(dat_s$all_gpa_e, na.rm = T) * 0.02))


# bf_gpa <- bayesfactor_parameters(
#   fit_gpa, 
#   null = c(-sd(dat_s$all_gpa_e, na.rm = T) * 0.01, 
#                sd(dat_s$all_gpa_e, na.rm = T) * 0.01),
#   direction = ">")
# 
# plot(bf_gpa, par = "b_treated_int")

# treatment heterogeneity of the main model across classrooms
summary(fit_gpa)$random

posterior_samples <- as_draws(fit_gpa, pars = "^class_id")
hdi(posterior_samples, ci = 0.89)

```

## Secondary outcomes

```{r}
fit_f1 <- brm(
    fscore_f1_e ~ fscore_f1_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id + all_gpa_b + 
      (treated_int | class_id),
    dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )
  
fit_f2 <- brm(
    fscore_f2_e ~ fscore_f2_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id + all_gpa_b +
      (treated_int | class_id),
    dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )
  
fit_f3 <- brm(
    fscore_f3_e ~ fscore_f3_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id + all_gpa_b +
      (treated_int | class_id),
    dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15))
```

```{r, include = F}
fit_f1 <- brm_multiple(
    fscore_f1_e ~ fscore_f1_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    dat_mi,
    prior = my_prior, 
    chains = 4,
    seed = 1234
  )
  
fit_f2 <- brm_multiple(
    fscore_f2_e ~ fscore_f2_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    dat_mi,
    prior = my_prior, 
    chains = 4,
    seed = 1234
  )
  
fit_f3 <- brm_multiple(
    fscore_f3_e ~ fscore_f3_b + treated_int +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    dat_mi,
    prior = my_prior, 
    chains = 4,
    seed = 1234)
```

```{r}
summary(fit_f1$rhats)# pretty good rhats
summary(fit_f2$rhats) # pretty good rhats
summary(fit_f3$rhats) # pretty good rhats

# posterior predictive checks suggest pretty good fit
p1 <- pp_check(fit_f1, ndraws = 200) +
  labs(title = "Posterior predictive checking for the model\npredicting self-esteem", 
       x = "Self-esteem", 
       y = "Density") + 
  xlim(-5,5) +
  theme_classic();p1

p2 <- pp_check(fit_f2, ndraws = 200) +
  labs(title = "Posterior predictive checking for the model\npredicting stereotype threat", 
       x = "Stereotype Threat", 
       y = "Density") + 
  xlim(-5,5) +
  theme_classic();p2

p3 <- pp_check(fit_f3, ndraws = 200) +
  labs(title = "Posterior predictive checking for the model\npredicting academic stress", 
       x = "Academic Stress", 
       y = "Density") + 
  xlim(-5,5) +
  theme_classic();p3

# loo suggests good predictive performance (not necessary though if I wish to focusing on interpreting the model parameters)
loo_f1 <- loo(fit_f1, reloo = T)
loo_f2 <- loo(fit_f2, reloo = T)
loo_f3 <- loo(fit_f3, reloo = T)
```

```{r}
# "marginal" finding on treatment reducing perceived stereotype threat
hypothesis(fit_f1, "treated_int > 0")
hypothesis(fit_f2, "treated_int < 0") #
hypothesis(fit_f3, "treated_int < 0")

par(mfrow = c(1, 3))

draws <- as_draws_df(fit_f2)

plot.kdensity(draws$b_treated_int, value = 0,
              xlab = "Estimated Difference (Treatment - Control)",
              main = "Posterior Distribution of the Treatment Effect\non Reducing Stereotype Threat")

# abline(v = c(-0.37, 0.06), col = "orange", lwd = 3)
# Add ROPE: a shaded rectangle between the lines
rect(-0.02, 0, 0.02, 4, col = rgb(1, 0.5, 0, alpha = 0.5), border = NA)

# posterior predictive plots
draws <- as_draws_df(fit_f1)

plot.kdensity(draws$b_treated_int, value = 0,
              xlab = "Estimated Difference (Treatment - Control)",
              main = "Posterior Distribution of the Treatment Effect on\nPromoting Self-efficacy and Sense of Belonging in School",
              col1 = "steelblue1",
              col2 = "firebrick1")

# Add ROPE: a shaded rectangle between the lines
rect(-0.02, 0, 0.02, 4, col = rgb(1, 0.5, 0, alpha = 0.5), border = NA)

draws <- as_draws_df(fit_f3)

plot.kdensity(draws$b_treated_int, value = 0,
              xlab = "Estimated Difference (Treatment - Control)",
              main = "Posterior Distribution of the Treatment Effect\non Reducing Academic Stress")

# Add ROPE: a shaded rectangle between the lines
rect(-0.02, 0, 0.02, 4, col = rgb(1, 0.5, 0, alpha = 0.5), border = NA)


# 95% high-density interval for reporting
hdi(fit_f1, ci = 0.89)
hdi(fit_f2, ci = 0.89)
hdi(fit_f3, ci = 0.89)

# posterior draws of Cohen's d effect size
hist(get.posterior.treat.d(fit_f1))
hist(get.posterior.treat.d(fit_f2))
hist(get.posterior.treat.d(fit_f3))

# sexit reporting based on empirical benchmarks in Bakker et al., 2019 and Kraft, 2020: small = 0.05, medium = 0.15, large = 0.2

# Sequential Effect eXistence and sIgnificance Testing (SEXIT) framework
sexit(fit_f1, significant = 0.02 * sd(dat_s$fscore_f1_e, na.rm = T), ci = 0.89)[3,]
sexit(fit_f2, significant = 0.02 * sd(dat_s$fscore_f2_e, na.rm = T), ci = 0.89)[3,]
sexit(fit_f3, significant = 0.02 * sd(dat_s$fscore_f3_e, na.rm = T), ci = 0.89)[3,]

rope(fit_f1, range = c(-0.02 * sd(dat_s$fscore_f2_e, na.rm = T), 0.02 * sd(dat_s$fscore_f2_e, na.rm = T)), ci = 0.89)
rope(fit_f2, range = c(-0.02 * sd(dat_s$fscore_f2_e, na.rm = T), 0.02 * sd(dat_s$fscore_f2_e, na.rm = T)), ci = 0.89)
rope(fit_f3, range = c(-0.02 * sd(dat_s$fscore_f2_e, na.rm = T), 0.02 * sd(dat_s$fscore_f2_e, na.rm = T)), ci = 0.89)
```

## Moderation effect (school subgroup)

```{r}
fit_gpa_x_sch_id <- brm(
    all_gpa_e ~ all_gpa_b + treated_int * sch_id +
      class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
      (treated_int | class_id),
    dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

interact_plot(model = fit_gpa_x_sch_id, 
              pred = "treated_int", 
              modx = "sch_id",
              legend.main = "School",
              pred.labels = c("Control", "Treatment"),
              x.label = "\nTreatment Condition",
              y.label = "Core Course GPA\n")
```


## Moderation effect (prior performance)

```{r}
# create low-performing variable
dat_s <- dat_s |> 
  group_by(class_id) |> 
  mutate(low_performing = as.numeric(all_gpa_b <= median(all_gpa_b)))
```

```{r}
# using baseline performance (dichotomous) as the moderator
fit_gpa_x_low_performance <- brm(
    all_gpa_e ~ all_gpa_b + treated_int * low_performing +
      class_size + grade + gender + age_b + student_type +
      father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    data = dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_gpa_x_low_performance, "treated_int > 0")

hypothesis(fit_gpa_x_low_performance, "treated_int:low_performing < 0")

hdi(fit_gpa_x_low_performance, ci = 0.89)
sexit(fit_gpa_x_low_performance)

# no interaction effect for low-performance because performance was already low for most students
```

```{r}
# using baseline performance (continuous) as the moderator
fit_gpa_x_low_performance_cont <- brm(
    all_gpa_e ~ all_gpa_b + treated_int * all_gpa_b +
      class_size + grade + gender + age_b + student_type +
      father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    data = dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_gpa_x_low_performance_cont, "treated_int > 0")

hypothesis(fit_gpa_x_low_performance_cont, "all_gpa_b:treated_int < 0")

hdi(fit_gpa_x_low_performance_cont, ci = 0.89)
sexit(fit_gpa_x_low_performance_cont)
```


## Moderation effect (psychological threat)

Interestingly, the affirmation effect is more pronounced for deaf students experiencing less stereotype threat (or psychological threat in general) at baseline.

Ferrer & Cohen (2018) mentioned that "for self-affirmation to be beneficial, there must be a threat to self-adequacy or self-integrity and, moreover, that psychological threat must impede behavior change." Therefore, it is reasonable to think that self-affirmation works better when there are more threats present (and especially when these threats impede adaptive behavior). 

In our study context, it is unlikely that stereotype threat "facilitates" adaptive outcomes since it is a major source of stress among deaf students. Therefore, the finding that the treatment effect is larger for deaf students experiencing less stereotype threat may arise due to uniqueness of the population and context. It is possible that for deaf students, there is a pervasive psychological threat that is salient in all aspects of their life. Those experiencing too much threat may not benefit much from a brief reflection exercise, while those experiencing relatively less threat (but still much more compared to hearing students) may be the proper target of self-affirmation.

Additionally, being in the poor-performing group at baseline does not moderate the treatment effect. This may again speak to the fact that for this particular population, affirmation seems to affect performance directly through alleviating stereotype threat.

*Composite psychological threat (average of all three factors)*

```{r}
dat_s$fscore_f1_b_rev <- -dat_s$fscore_f1_b

dat_s$psych_threat <- rowMeans(dat_s[, c("fscore_f1_b_rev", "fscore_f2_b", "fscore_f2_b")], na.rm = T)

hist(dat_s$psych_threat)

fit_gpa_x_psych_threat <- brm(
    all_gpa_e ~ all_gpa_b + treated_int * psych_threat + class_size + grade + gender + age_b + student_type +
      father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    data = dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15))


hypothesis(fit_gpa_x_psych_threat, "treated_int > 0")
hypothesis(fit_gpa_x_psych_threat, "treated_int:psych_threat < 0")

hdi(fit_gpa_x_psych_threat, ci = 0.89)

# consider es = 0.02 as negligible
rope(fit_gpa_x_psych_threat, ci = 0.89, 
     range = c(-sd(dat_s$all_gpa_e, na.rm = T) * 0.02, 
               sd(dat_s$all_gpa_e, na.rm = T) * 0.02))

# using the empirical benchmark in Kraft (2020)
sexit(fit_gpa_x_psych_threat, significant = 0.05 * sd(dat_s$all_gpa_e, na.rm = T), large = 0.2 * sd(dat_s$all_gpa_e, na.rm = T), ci = 0.89)[3,]


p1 <- interact_plot(model = fit_gpa_x_psych_threat, 
              pred = "treated_int", 
              modx = "psych_threat",
              legend.main = "Psychological Threat",
              pred.labels = c("Control", "Treatment"),
              x.label = "\nTreatment Condition",
              y.label = "GPA\n") + 
  theme_minimal();p1
```

```{r}
# simple slope effect
dat_s <- dat_s |> 
  mutate(psych_threat_p1sd = psych_threat + sd(psych_threat, na.rm = T),
         psych_threat_m1sd = psych_threat - sd(psych_threat, na.rm = T))

# treatment effect for high threat
fit_gpa_x_psych_threat_high <- brm(
    all_gpa_e ~ all_gpa_b + treated_int * psych_threat_m1sd + class_size + grade + gender + age_b + student_type +
      father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    data = dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15))

hypothesis(fit_gpa_x_psych_threat_high, "treated_int > 0")
hdi(fit_gpa_x_psych_threat_high, ci = 0.89)

# treatment effect for low threat
fit_gpa_x_psych_threat_low <- brm(
    all_gpa_e ~ all_gpa_b + treated_int * psych_threat_p1sd + class_size + grade + gender + age_b + student_type +
      father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    data = dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15))

hypothesis(fit_gpa_x_psych_threat_low, "treated_int > 0")
hdi(fit_gpa_x_psych_threat_low, ci = 0.89)
```


*Stereotype threat only*

```{r}

hist(dat_s$fscore_f2_b)

fit_gpa_x_stereotype_threat <- brm(
    all_gpa_e ~ all_gpa_b + treated_int * fscore_f2_b + class_size + grade + gender + age_b + student_type + 
      father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    data = dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15))


hypothesis(fit_gpa_x_stereotype_threat, "treated_int > 0")
hypothesis(fit_gpa_x_stereotype_threat, "treated_int:fscore_f2_b < 0")


hdi(fit_gpa_x_stereotype_threat, ci = 0.89)


# consider es = 0.01 as negligible
rope(fit_gpa_x_stereotype_threat, ci = 0.89, 
     range = c(-sd(dat_s$all_gpa_e, na.rm = T) * 0.01, 
               sd(dat_s$all_gpa_e, na.rm = T) * 0.01))

# using the empirical benchmark in Kraft (2020)
sexit(fit_gpa_x_stereotype_threat, significant = 0.05 * sd(dat_s$all_gpa_e, na.rm = T), large = 0.2 * sd(dat_s$all_gpa_e, na.rm = T), ci = 0.89)[3,]


p2 <- interact_plot(model = fit_gpa_x_stereotype_threat, 
              pred = "treated_int", 
              modx = "fscore_f2_b",
              legend.main = "Stereotype Threat",
              pred.labels = c("Control", "Treatment"),
              x.label = "\nTreatment Condition",
              y.label = "GPA\n") + theme_minimal(); p2

gridExtra::grid.arrange(p1, p2, nrow = 1)
```

```{r}
# simple slope effect
dat_s <- dat_s |> 
  mutate(fscore_f2_b_p1sd = fscore_f2_b + sd(fscore_f2_b, na.rm = T),
         fscore_f2_b_m1sd = fscore_f2_b - sd(fscore_f2_b, na.rm = T))

# treatment effect for high threat
fit_gpa_x_stereotype_threat_high <- brm(
    all_gpa_e ~ all_gpa_b + treated_int * fscore_f2_b_m1sd + class_size + grade + gender + age_b + student_type +
      father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    data = dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15))

hypothesis(fit_gpa_x_stereotype_threat_high, "treated_int > 0")
hdi(fit_gpa_x_stereotype_threat_high, ci = 0.89)

# treatment effect for low threat
fit_gpa_x_stereotype_threat_low <- brm(
    all_gpa_e ~ all_gpa_b + treated_int * fscore_f2_b_p1sd + class_size + grade + gender + age_b + student_type +
      father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (treated_int | class_id),
    data = dat_s,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15))

hypothesis(fit_gpa_x_stereotype_threat_low, "treated_int > 0")
hdi(fit_gpa_x_stereotype_threat_low, ci = 0.89)
```

## Mediation Model

*Stereotype threat as a mediator*
```{r}
# Mediator model
mediator_model <- bf(fscore_f2_e ~ fscore_f2_b + treated_int + class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f + father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + (treated_int | class_id))

# Outcome model with mediator (fscore_f2_e) included
outcome_model <- bf(all_gpa_e ~ all_gpa_b + fscore_f2_e + treated_int + class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f + father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + (treated_int | class_id))

# Fit the Bayesian mediation model
mediation_model <- brm(mediator_model + outcome_model + set_rescor(FALSE),
                       data = dat_s, 
                       prior = my_prior,
                       chains = 4,
                       seed = 1234)

# not mediated through stereotype threat
mediation(mediation_model, method = "HDI")
```

*Interdependent word count as a mediator*
```{r}
# Mediator model
mediator_model <- bf(inter_count_int ~ ind_count_int + total_count_int + treated_int + class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f + father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + (treated_int | class_id))

# Outcome model with mediator (inter_count_int) included
outcome_model <- bf(all_gpa_e ~ all_gpa_b + inter_count_int + treated_int + class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f + father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + (treated_int | class_id))

# Fit the Bayesian mediation model
mediation_model <- brm(mediator_model + outcome_model + set_rescor(FALSE),
                       data = dat_s, 
                       prior = my_prior,
                       chains = 4,
                       seed = 1234)

# not mediated through Interdependent word count
mediation(mediation_model, method = "HDI")
```

*Independent word count as a mediator*
```{r}
# Mediator model
mediator_model <- bf(ind_count_int ~ inter_count_int + total_count_int + treated_int + class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f + father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + (treated_int | class_id))

# Outcome model with mediator (ind_count_int) included
outcome_model <- bf(all_gpa_e ~ all_gpa_b + ind_count_int + treated_int + class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f + father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + (treated_int | class_id))

# Fit the Bayesian mediation model
mediation_model <- brm(mediator_model + outcome_model + set_rescor(FALSE),
                       data = dat_s, 
                       prior = my_prior,
                       chains = 4,
                       seed = 1234)

# not mediated through Independent word count
mediation(mediation_model, method = "HDI")
```

## Predicted Values
```{r}
dat_pred <- dat_s |> select(
      st_id, sch_id, all_gpa_e, all_gpa_b, treated_int, class_size, grade, gender, age_b, student_type,
      father_edu_f, mother_edu_f, 
      father_occ_salary, mother_occ_salary, adult_members, siblings, duration_int) |> 
  na.omit() |> 
  mutate(grade = droplevels(grade))
  
dat_pred$gpa_pred <- predict(fit_gpa, newdata = dat_pred)[,1]
```

```{r}
df <- dat_pred |> 
  group_by(treated_int, class_id) |>
  mutate(class_id = as.numeric(class_id)) |> 
  summarise(m_b = mean(all_gpa_b, na.rm = T),
            se_b = sd(all_gpa_b, na.rm = T)/sqrt(length(all_gpa_b)),
            m_e = mean(gpa_pred, na.rm = T),
            se_e = sd(gpa_pred, na.rm = T)/sqrt(length(gpa_pred))
            )

df <- df |> 
  pivot_longer(cols = m_b:se_e,
               names_to = c("stat", "time"),
               names_pattern = "(.*)_(.*)",
               values_to = "value")

df <- df |> 
  pivot_wider(names_from = "stat", values_from = "value")

df <- df |> 
  mutate(treated_int = ifelse(treated_int == 1,
                              "Treatment",
                              "Control")
         # sch_id = case_when(
         #   sch_id == 1 ~ "Baglung",
         #   sch_id == 2 ~ "Kathmandu",
         #   sch_id == 3 ~ "Pokhara")
         )  |> 
  mutate(class_id = case_when(
           class_id %in% c(1:5) ~ paste0("School A Grade ", class_id + 5),
           class_id %in% c(8:12) ~ paste0("School B Grade ", class_id - 2),
           class_id %in% c(15:19) ~ paste0("School C Grade ", class_id - 9)
         )) |> 
  mutate(class_id = factor(class_id,
                           levels = c(
                             paste0("School A Grade ", 6:10),
                             paste0("School B Grade ", 6:10),
                             paste0("School C Grade ", 6:10)
                           ))) |> 
  rename(Condition = treated_int)

df <- df |> 
  mutate(time = ifelse(time == "b", "Baseline", "Endline"))

ggplot(data = df,
       aes(x = time, y = m, group = Condition,
           color = Condition)) +
  geom_line(position=position_dodge(0.2))+
  geom_point(size = 2, position=position_dodge(0.2)) +
  geom_errorbar(aes(ymin=m-se, ymax=m+se), width=.2,
                 position=position_dodge(0.2)) +
  labs(x = "", y = "GPA\n",
       title = "Average Raw GPA at Baseline and Model-Estimated GPA at Endline\nby Treatment Conditions and Classes\n",
       caption = "(Each error bar shows the standard error of the group mean.)") +
  facet_wrap(~class_id, nrow = 3) +
  theme_minimal() +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
   scale_color_manual(values=c('firebrick1','steelblue1')) + 
  ylim(c(1,3.5))

```

## Subgroup Analysis (effect of independence/interdependence)

```{r}
fit_gpa_treated <- brm(
    all_gpa_e ~ all_gpa_b + ind_count_int + inter_count_int + total_count_int +
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_treated,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_gpa_treated, "ind_count_int > 0")
hypothesis(fit_gpa_treated, "inter_count_int > 0")
hypothesis(fit_gpa_treated, "total_count_int > 0") ##
hypothesis(fit_gpa_treated, "duration_int > 0") #
hypothesis(fit_gpa_treated, "ind_count_int:inter_count_int > 0")

corstarsl(dat_s |> select(ind_count_int, inter_count_int, total_count_int, duration_int))


interact_plot(model = fit_gpa_treated, 
              pred = "inter_count_int", 
              modx = "ind_count_int",
              legend.main = "Number of Indepedent Words",
              x.label = "\nNumber of Interdependent Words",
              y.label = "GPA\n") +
  theme_minimal()

```

```{r}
fit_f1_treated <- brm(
    fscore_f1_e ~ fscore_f1_b + ind_count_int * inter_count_int + total_count_int +
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_treated,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_f1_treated, "ind_count_int > 0")
hypothesis(fit_f1_treated, "inter_count_int > 0")
hypothesis(fit_f1_treated, "total_count_int > 0")
hypothesis(fit_f1_treated, "duration_int > 0") #
hypothesis(fit_f1_treated, "ind_count_int:inter_count_int > 0")


interact_plot(model = fit_f1_treated, 
              pred = "inter_count_int", 
              modx = "ind_count_int",
              legend.main = "Number of Indepedent Words",
              x.label = "\nNumber of Interdependent Words",
              y.label = "Self-integrity and Sense of Belonging in School\n") +
  theme_minimal()
```

```{r}
fit_f2_treated <- brm(
    fscore_f2_e ~ fscore_f2_b + ind_count_int + inter_count_int + total_count_int +
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_treated,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_f2_treated, "ind_count_int < 0")
hypothesis(fit_f2_treated, "inter_count_int > 0") # increased stereotype threat
hypothesis(fit_f2_treated, "total_count_int < 0") #
hypothesis(fit_f2_treated, "duration_int < 0") #
hypothesis(fit_f2_treated, "ind_count_int:inter_count_int > 0")


interact_plot(model = fit_f2_treated, 
              pred = "inter_count_int", 
              modx = "ind_count_int",
              legend.main = "Number of Indepedent Words",
              x.label = "\nNumber of Interdependent Words",
              y.label = "Stereotype Threat\n") +
  theme_minimal()
```

```{r}
fit_f3_treated <- brm(
    fscore_f3_e ~ fscore_f3_b + ind_count_int * inter_count_int + total_count_int +
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_treated,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_f3_treated, "ind_count_int < 0") #
hypothesis(fit_f3_treated, "inter_count_int < 0") #
hypothesis(fit_f3_treated, "total_count_int < 0")
hypothesis(fit_f3_treated, "duration_int < 0")
hypothesis(fit_f3_treated, "ind_count_int:inter_count_int > 0") #


interact_plot(model = fit_f3_treated, 
              pred = "inter_count_int", 
              modx = "ind_count_int",
              legend.main = "Number of Indepedent Words",
              x.label = "\nNumber of Interdependent Words",
              y.label = "Academic Stress\n") +
  theme_minimal()
```

## Subgroup Analysis (effect of thematic codes in the treatment group)

Test suppressor effect by putting only one variable in the model

```{r}
fit_gpa_treated_qual <- brm(
    all_gpa_e ~ all_gpa_b + 
      theme_t_interest_and_learn_new_things +
      theme_t_religion_heritage +
      theme_t_career_aspirations + 
      theme_t_non_career_aspirations +
      theme_t_self_identity +
      theme_t_relationship_with_family +
      theme_t_relationship_with_friends +
      theme_t_prosocial_behavior +
      total_count_int + 
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_treated,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_gpa_treated_qual, "theme_t_interest_and_learn_new_things < 0") #
hypothesis(fit_gpa_treated_qual, "theme_t_religion_heritage > 0") #
hypothesis(fit_gpa_treated_qual, "theme_t_career_aspirations < 0") #
hypothesis(fit_gpa_treated_qual, "theme_t_non_career_aspirations > 0")
hypothesis(fit_gpa_treated_qual, "theme_t_self_identity > 0") ##
hypothesis(fit_gpa_treated_qual, "theme_t_relationship_with_family > 0")
hypothesis(fit_gpa_treated_qual, "theme_t_relationship_with_friends > 0") ##
hypothesis(fit_gpa_treated_qual, "theme_t_prosocial_behavior > 0")
hypothesis(fit_gpa_treated_qual, "total_count_int > 0") ##

corstarsl(dat_s |> select(ind_count_int, theme_t_interest_and_learn_new_things:theme_t_prosocial_behavior))
```

```{r}
# posterior predictive plots
draws <- as_draws_df(fit_gpa_treated_qual)

# Convert the relevant b_theme variables to long format
draws_long <- draws %>%
  as.data.frame() %>%
  select(starts_with("b_theme")) %>%
  gather(key = "variable", value = "value") %>%
  mutate(variable = str_replace_all(variable, "^b_theme_t_", ""),
         variable = str_replace_all(variable, "_", " "),
         variable = str_to_title(variable)) |> 
  mutate(variable = case_when(
    variable == "Career Aspirations" ~ "Career-related Aspirations",
    variable == "Interest And Learn New Things" ~ "Personal Interests",
    variable == "Non Career Aspirations" ~ "Non-career-related Aspirations",
    variable == "Prosocial Behavior" ~ "Broader Prosocial Behavior",
    variable == "Relationship With Family" ~ "Relationship with Family",
    variable == "Relationship With Friends" ~ "Relationship with Friends",
    variable == "Religion Heritage" ~ "Religious and Cultural Values",
    variable == "Self Identity" ~ "Self-awareness and Growth in Self-identity"
  ))

# Define ROPE
rope_low <- -sd(dat_s$all_gpa_e, na.rm = TRUE) * 0.02
rope_high <- sd(dat_s$all_gpa_e, na.rm = TRUE) * 0.02

# Compute the density for each group
densities <- lapply(split(draws_long$value, draws_long$variable), density)

# Combine the densities into a single data frame
density_data <- do.call(rbind, mapply(function(dens, name) {
  data.frame(x = dens$x, y = dens$y, variable = name)
}, densities, names(densities), SIMPLIFY = FALSE))

density_data <- density_data |> 
  mutate(variable = factor(variable, 
                           levels = c("Personal Interests",
                                      "Career-related Aspirations",
                                      "Non-career-related Aspirations",
                                      "Religious and Cultural Values",
                                      "Self-awareness and Growth in Self-identity",
                                      "Relationship with Family",
                                      "Relationship with Friends",
                                      "Broader Prosocial Behavior"
                                      )))

# Plot using geom_ribbon
ggplot(density_data, aes(x = x, ymin = 0, ymax = y)) +
  geom_ribbon(aes(fill = ifelse(x < 0, "firebrick1", "steelblue1")), 
              alpha = 0.9, 
              show.legend = FALSE) +
  scale_fill_identity() + 
  geom_rect(aes(xmin = rope_low, xmax = rope_high, ymin = 0, ymax = Inf),
            fill = "orange",
            alpha = 0.05,
            color = NA) +
  facet_grid(variable ~ ., scales = "fixed", space = "free") +
  labs(
    x = "Posterior Estimates of Regression Coefficients",
    y = "Density",
    title = ""
  ) +
  theme_minimal() +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_text(angle = 0, face = "bold")
  )

```

```{r}
# 95% high-density interval for reporting
hdi(fit_gpa_treated_qual, ci = 0.89)

# Sequential Effect eXistence and sIgnificance Testing (SEXIT) framework
# using the empirical benchmark in Kraft (2020)
sexit(fit_gpa_treated_qual, significant = 0.02 * sd(dat_s$all_gpa_e, na.rm = T), large = 0.05 * sd(dat_s$all_gpa_e, na.rm = T), ci = 0.89)[3,]

# consider es = 0.01 as negligible
rope(fit_gpa_treated_qual, ci = 0.89, 
     range = c(-sd(dat_s$all_gpa_e, na.rm = T) * 0.02, 
               sd(dat_s$all_gpa_e, na.rm = T) * 0.02))

```


```{r}
fit_f1_treated_qual <- brm(
    fscore_f1_e ~ fscore_f1_b + 
      theme_t_interest_and_learn_new_things +
      theme_t_religion_heritage +
      theme_t_career_aspirations + 
      theme_t_non_career_aspirations +
      theme_t_self_identity +
      theme_t_relationship_with_family +
      theme_t_relationship_with_friends +
      theme_t_prosocial_behavior +
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_treated,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_f1_treated_qual, "theme_t_interest_and_learn_new_things < 0") #
hypothesis(fit_f1_treated_qual, "theme_t_religion_heritage < 0") #
hypothesis(fit_f1_treated_qual, "theme_t_career_aspirations < 0") ##
hypothesis(fit_f1_treated_qual, "theme_t_non_career_aspirations > 0")
hypothesis(fit_f1_treated_qual, "theme_t_self_identity > 0")
hypothesis(fit_f1_treated_qual, "theme_t_relationship_with_family > 0") #
hypothesis(fit_f1_treated_qual, "theme_t_relationship_with_friends > 0")
hypothesis(fit_f1_treated_qual, "theme_t_prosocial_behavior > 0")

```

```{r}
fit_f2_treated_qual <- brm(
    fscore_f2_e ~ fscore_f2_b + 
      theme_t_interest_and_learn_new_things +
      theme_t_religion_heritage +
      theme_t_career_aspirations + 
      theme_t_non_career_aspirations +
      theme_t_self_identity +
      theme_t_relationship_with_family +
      theme_t_relationship_with_friends +
      theme_t_prosocial_behavior +
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_treated,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_f2_treated_qual, "theme_t_interest_and_learn_new_things < 0")
hypothesis(fit_f2_treated_qual, "theme_t_religion_heritage > 0")
hypothesis(fit_f2_treated_qual, "theme_t_career_aspirations < 0") #
hypothesis(fit_f2_treated_qual, "theme_t_non_career_aspirations > 0")
hypothesis(fit_f2_treated_qual, "theme_t_self_identity < 0") #
hypothesis(fit_f2_treated_qual, "theme_t_relationship_with_family > 0") ##
hypothesis(fit_f2_treated_qual, "theme_t_relationship_with_friends < 0") #
hypothesis(fit_f2_treated_qual, "theme_t_prosocial_behavior > 0") #

```


```{r}
fit_f3_treated_qual <- brm(
    fscore_f3_e ~ fscore_f3_b + 
      theme_t_interest_and_learn_new_things +
      theme_t_religion_heritage +
      theme_t_career_aspirations + 
      theme_t_non_career_aspirations +
      theme_t_self_identity +
      theme_t_relationship_with_family +
      theme_t_relationship_with_friends +
      theme_t_prosocial_behavior +
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_treated,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_f3_treated_qual, "theme_t_interest_and_learn_new_things > 0")
hypothesis(fit_f3_treated_qual, "theme_t_religion_heritage > 0") #
hypothesis(fit_f3_treated_qual, "theme_t_career_aspirations > 0") #
hypothesis(fit_f3_treated_qual, "theme_t_non_career_aspirations > 0")
hypothesis(fit_f3_treated_qual, "theme_t_self_identity > 0")
hypothesis(fit_f3_treated_qual, "theme_t_relationship_with_family > 0")
hypothesis(fit_f3_treated_qual, "theme_t_relationship_with_friends < 0")
hypothesis(fit_f3_treated_qual, "theme_t_prosocial_behavior > 0")

```

## Subgroup Analysis (effect of thematic codes in the control group)

```{r}
fit_gpa_control_qual <- brm(
    all_gpa_e ~ all_gpa_b + 
      theme_c_no_knowledge +
      theme_c_no_interest +
      theme_c_communication_barriers +
      theme_c_no_support + 
      theme_o_aspirations +
      theme_o_interest_ability +
      theme_o_reward +
      theme_o_support +
      total_count_int +
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_control,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_gpa_control_qual, "theme_c_no_knowledge < 0")
hypothesis(fit_gpa_control_qual, "theme_c_no_interest < 0")
hypothesis(fit_gpa_control_qual, "theme_c_communication_barriers < 0")
hypothesis(fit_gpa_control_qual, "theme_c_no_support < 0")

hypothesis(fit_gpa_control_qual, "theme_o_aspirations > 0") #
hypothesis(fit_gpa_control_qual, "theme_o_interest_ability < 0") #
hypothesis(fit_gpa_control_qual, "theme_o_reward > 0")
hypothesis(fit_gpa_control_qual, "theme_o_support > 0") #
```

```{r}
# posterior predictive plots
draws <- as_draws_df(fit_gpa_control_qual)

# Convert the relevant b_theme variables to long format
draws_long <- draws %>%
  as.data.frame() %>%
  select(starts_with("b_theme")) %>%
  gather(key = "variable", value = "value") %>%
  mutate(variable = str_replace_all(variable, "^b_theme_[co]_", ""),
         variable = str_replace_all(variable, "_", " "),
         variable = str_to_title(variable)) |> 
  mutate(variable = case_when(
    variable == "No Knowledge" ~ "Lack of Knowledge",
    variable == "No Interest" ~ "Lack of Interest",
    variable == "Communication Barriers" ~ "Barriers Related to Deafness and Communication",
    variable == "No Support" ~ "Lack of Support from Friends and Family",
    variable == "Aspirations" ~ "Aspirations Held by Others",
    variable == "Interest Ability" ~ "Interests or Ability of Others",
    variable == "Reward" ~ "Reward for Others",
    variable == "Support" ~ "Availability of Support for Others from Friends and Family"
  ))

# Define ROPE
rope_low <- -sd(dat_s$all_gpa_e, na.rm = TRUE) * 0.02
rope_high <- sd(dat_s$all_gpa_e, na.rm = TRUE) * 0.02

# Compute the density for each group
densities <- lapply(split(draws_long$value, draws_long$variable), density)

# Combine the densities into a single data frame
density_data <- do.call(rbind, mapply(function(dens, name) {
  data.frame(x = dens$x, y = dens$y, variable = name)
}, densities, names(densities), SIMPLIFY = FALSE))

density_data <- density_data |> 
  mutate(variable = factor(variable, 
                           levels = c("Lack of Knowledge",
                                      "Lack of Interest",
                                      "Barriers Related to Deafness and Communication",
                                      "Lack of Support from Friends and Family",
                                      "Interests or Ability of Others",
                                      "Aspirations Held by Others",
                                      "Reward for Others",
                                      "Availability of Support for Others from Friends and Family"
                                      )))

# Plot using geom_ribbon
ggplot(density_data, aes(x = x, ymin = 0, ymax = y)) +
  geom_ribbon(aes(fill = ifelse(x < 0, "firebrick1", "steelblue1")), 
              alpha = 0.9, 
              show.legend = FALSE) +
  scale_fill_identity() + 
  geom_rect(aes(xmin = rope_low, xmax = rope_high, ymin = 0, ymax = Inf),
            fill = "orange",
            alpha = 0.05,
            color = NA) +
  facet_grid(variable ~ ., scales = "fixed", space = "free") +
  labs(
    x = "Posterior Estimates of Regression Coefficients",
    y = "Density",
    title = ""
  ) +
  theme_minimal() +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_text(angle = 0, face = "bold")
  )

```

```{r}
# 95% high-density interval for reporting
hdi(fit_gpa_control_qual, ci = 0.89)

# Sequential Effect eXistence and sIgnificance Testing (SEXIT) framework
# using the empirical benchmark in Kraft (2020)
sexit(fit_gpa_control_qual, significant = 0.02 * sd(dat_s$all_gpa_e, na.rm = T), large = 0.05 * sd(dat_s$all_gpa_e, na.rm = T), ci = 0.89)[3,]

# consider es = 0.01 as negligible
rope(fit_gpa_control_qual, ci = 0.89, 
     range = c(-sd(dat_s$all_gpa_e, na.rm = T) * 0.02, 
               sd(dat_s$all_gpa_e, na.rm = T) * 0.02))

```

```{r}
fit_f1_control_qual <- brm(
    fscore_f1_e ~ fscore_f1_b + 
      theme_c_no_knowledge +
      theme_c_no_interest +
      theme_c_communication_barriers +
      theme_c_no_support + 
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_control,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_f1_control_qual, "theme_c_no_knowledge < 0")
hypothesis(fit_f1_control_qual, "theme_c_no_interest > 0") #
hypothesis(fit_f1_control_qual, "theme_c_communication_barriers > 0")
hypothesis(fit_f1_control_qual, "theme_c_no_support > 0") #

```

```{r}
fit_f2_control_qual <- brm(
    fscore_f2_e ~ fscore_f2_b + 
      theme_c_no_knowledge +
      theme_c_no_interest +
      theme_c_communication_barriers +
      theme_c_no_support + 
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_control,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_f2_control_qual, "theme_c_no_knowledge < 0")
hypothesis(fit_f2_control_qual, "theme_c_no_interest < 0")
hypothesis(fit_f2_control_qual, "theme_c_communication_barriers < 0")
hypothesis(fit_f2_control_qual, "theme_c_no_support > 0")

```

```{r}
fit_f3_control_qual <- brm(
    fscore_f3_e ~ fscore_f3_b + 
      theme_c_no_knowledge +
      theme_c_no_interest +
      theme_c_communication_barriers +
      theme_c_no_support + 
      class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
      father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int + sch_id +
      (1 | class_id),
    dat_control,
    prior = my_prior, 
    chains = 4,
    seed = 1234,
    control = list(adapt_delta = 0.99,
                   max_treedepth = 15)
  )

hypothesis(fit_f3_control_qual, "theme_c_no_knowledge > 0") #
hypothesis(fit_f3_control_qual, "theme_c_no_interest < 0") #
hypothesis(fit_f3_control_qual, "theme_c_communication_barriers > 0")
hypothesis(fit_f3_control_qual, "theme_c_no_support < 0") #

```