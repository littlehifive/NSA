---
title: "NSA Exploratory Analysis"
author: "Michael Wu"
date: "3/27/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data preparation, include = F}
library(tidyverse)
library(targets)
library(lme4)
library(rstanarm)
library(lavaan)
library(blavaan)
library(semTools)
library(kfa)

# stan option
options(mc.cores = parallel::detectCores())

# reversed coded master dataset
dat <- tar_read(dat_all_cleaned_reverse_coded)

# combine coded master dataset
dat_t <- tar_read(dat_all_cleaned_combine_coded)

dim(dat)
```

# EDA

```{r}
ds <- skimr::skim(dat) %>% 
  dplyr::mutate_if(is.numeric, round, 3) %>%
  dplyr::rename_with( ~ gsub("^(numeric.)(.*)$", "\\2", .x),
                      dplyr::starts_with("numeric.")) %>%
  dplyr::select(-skim_type, -hist) %>%
  dplyr::rename(variable = skim_variable)
  
flextable::flextable(ds) %>%
  flextable::align(part = "all") %>%
  flextable::font(fontname = "Times", part = "all") %>% 
  flextable::bold(part = "header") %>%
  flextable::fontsize(size = 10, part = "body") %>% 
  flextable::line_spacing(space = 1) %>%
  flextable::set_table_properties(layout = "autofit")
```

```{r}
ds <- skimr::skim(dat |> filter(student_type == "Hearing"))

ds
```

```{r}

dat_s <- dat[,unlist(lapply(dat, is.numeric))]

dat_s <- dat_s[,1:30]
dat_s <- dat_s[,31:59]


par(mfrow = c(5,6))
for (i in 1:ncol(dat_s)) {
  hist(dat_s[,i], xlab = "", main = names(dat_s)[i])
}
```

# Exploratory models for averaged survey outcomes

```{r}
fit_self_integrity <- stan_lmer(
  self_integrity_e ~ self_integrity_b + treated_int + 
    gender + age_b + student_type + father_edu + mother_edu +
    father_occ + mother_occ + adult_members + siblings + duration_int + 
    (treated_int | grade),
  dat
)

fit_self_esteem <- stan_lmer(
  self_esteem_e ~ self_esteem_b + treated_int + 
    gender + age_b + student_type + father_edu + mother_edu +
    father_occ + mother_occ + adult_members + siblings + duration_int +
    (treated_int | grade),
  dat
)

fit_belonging <- stan_lmer(
  belong_school_e ~ belong_school_b + treated_int + 
    gender + age_b + student_type + father_edu + mother_edu +
    father_occ + mother_occ + adult_members + siblings + duration_int +
    (treated_int | grade),
  dat
)

fit_stereotype <- stan_lmer(
  stereotype_e ~ stereotype_b + treated_int + 
    gender + age_b + student_type + father_edu + mother_edu +
    father_occ + mother_occ + adult_members + siblings + duration_int +
    (treated_int | grade),
  dat
)

fit_threat_collective <- stan_lmer(
  threat_collective_e ~ threat_collective_b + treated_int + 
    gender + age_b + student_type + father_edu + mother_edu +
    father_occ + mother_occ + adult_members + siblings + duration_int +
    (treated_int | grade),
  dat
)

fit_threat_stereotype <- stan_lmer(
  threat_stereotype_e ~ threat_stereotype_b + treated_int + 
    gender + age_b + student_type + father_edu + mother_edu +
    father_occ + mother_occ + adult_members + siblings + duration_int +
    (treated_int | grade),
  dat
)

fit_threat_general <- stan_lmer(
  threat_general_e ~ threat_general_b + treated_int + 
    gender + age_b + student_type + father_edu + mother_edu +
    father_occ + mother_occ + adult_members + siblings + duration_int +
    (treated_int | grade),
  dat
)

fit_academic_stress <- stan_lmer(
  academic_stress_e ~ academic_stress_b + treated_int + 
    gender + age_b + student_type + father_edu + mother_edu +
    father_occ + mother_occ + adult_members + siblings + duration_int +
    (treated_int | grade),
  dat
)
```

```{r}
# library(report)
# report(fit_self_integrity)

# missing data is an issue with more complex models

summary(fit_self_integrity, digits = 3) # no treatment effect
summary(fit_self_esteem, digits = 3) # positive treatment effect
summary(fit_belonging, digits = 3) # no treatment effect
summary(fit_stereotype, digits = 3) # no treatment effect
summary(fit_threat_collective, digits = 3) # no treatment effect
summary(fit_threat_stereotype, digits = 3) # no treatment effect
summary(fit_threat_general, digits = 3) # positive treatment effect (i.e. reducing stereotype)
summary(fit_academic_stress, digits = 3) # no treatment effect


```

Affirmation increased students' self-esteem and reduced their perceived stereotype threat (but not the perceived stereotype). 

That said, I will need to check the validity and reliability of these measures first. If they are not reliable, then it probably doesn't make too much sense to use them as outcomes.

# Factor analysis

## Internal consistency (raw data)

```{r}
# correlation matrix (need poly = T to get polychoric correlation)
# baseline
psych::cor.ci(dat |> select(capable_person_b:respect_lookup_b))

# endline
psych::cor.ci(dat |> select(capable_person_e:pressure_parent_teacher_e))

```

```{r}
# I specified 1 factor when calculating omega

# self-integrity 
df <- dat |> select(capable_person_b:comfortable_who_i_am_b)
get.ordinal.omega(df) # 0.55
psych::omega(df, nfactors = 1) # 0.4

df <- dat |> select(capable_person_e:comfortable_who_i_am_e)
get.ordinal.omega(df) # 0.66
psych::omega(df, nfactors = 1) # 0.58

# self-esteem
df <- dat |> select(feel_smart_b:worried_other_think_b)
get.ordinal.omega(df) # 0.5
psych::omega(df, nfactors = 1) # 0.44

df <- dat |> select(feel_smart_e:worried_other_think_e)
get.ordinal.omega(df) # 0.49
psych::omega(df, nfactors = 1) # 0.48

# belonging
df <- dat |> select(belong_school_b:ppl_like_me_b)
get.ordinal.omega(df) # 0.52

df <- dat |> select(belong_school_e:ppl_like_me_e)
get.ordinal.omega(df) # 0.42

# stereotype
df <- dat |> select(worry_abt_dumb_b:worry_ppl_dislike_b)
get.ordinal.omega(df) # 0.6

df <- dat |> select(worry_abt_dumb_e:worry_ppl_dislike_e)
get.ordinal.omega(df) # 0.53

# stereotype all items
df <- dat |> select(worry_abt_dumb_b:conclusion_abt_me_b)
get.ordinal.omega(df) # 0.75

df <- dat |> select(worry_abt_dumb_e:conclusion_abt_me_e)
get.ordinal.omega(df) # 0.72

# academic stress
df <- dat |> select(bad_grades_b:pressure_parent_teacher_b)
get.ordinal.omega(df) # 0.77

df <- dat |> select(bad_grades_e:pressure_parent_teacher_e)
get.ordinal.omega(df) # 0.78

```

Except for academic stress, the other scales all had medium to low reliability. This is probably because the other scales only have selected items from the original scale.

It also seems to make sense to combine the items on perceived stereotype and perceived stereotype threat, the resulting construct having a very good reliability.

Now we need to figure out how to deal with items on self-integrity, self-esteem, and social belonging. Combining self-integrity and self-esteem seems to be a good idea, because both constructs supposedly measure beliefs about the self. 

There doesn't seem to be a theory-based solution to combine belonging with other constructs.

```{r}
# self-integrity & self-esteem
df <- dat |> select(capable_person_b:worried_other_think_b)
get.ordinal.omega(df, nfactors = 1) # 0.65

df <- dat |> select(capable_person_e:worried_other_think_e)
get.ordinal.omega(df, nfactors = 2) # 0.64

## removing the two items that have the wrong signs (probably because the negative phrasing is too confusing for deaf kids)
df <- dat |> select(capable_person_b:worried_other_think_b,
                      -concerned_abt_impression_b,-worried_other_think_b)
get.ordinal.omega(df) # 0.64

df <- dat |> select(capable_person_e:worried_other_think_e,
                      -concerned_abt_impression_e,-worried_other_think_e)
get.ordinal.omega(df) # 0.56

# belonging
df <- dat |> select(belong_school_b:ppl_like_me_b)
get.ordinal.omega(df) # 0.52

df <- dat |> select(belong_school_e:ppl_like_me_e)
get.ordinal.omega(df) # 0.42

## removing the two items that have the wrong signs (probably because the negative phrasing is too confusing for deaf kids)
df <- dat |> select(belong_school_b:ppl_like_me_b, 
                      -feel_outsider_b, -teacher_like_me_b)
get.ordinal.omega(df) # 0.59

df <- dat |> select(belong_school_e:ppl_like_me_e,
                      -feel_outsider_e, -teacher_like_me_e)
get.ordinal.omega(df) # 0.42
```

## Internal consistency (with transformation)

It looks like the deaf kids' responses to the survey items are heavily weighted on 2s and 4s, due to the two-stage way the questions were asked. Therefore I transform the 5-point scale to 3-point scale for the deaf kids and the hearing kids as well (just to be consistent for factor analysis).

```{r}
skimr::skim(dat_t)
```

```{r}
# correlation matrix
# baseline
psych::cor.ci(dat_t |> select(capable_person_b:pressure_parent_teacher_b))

# endline
psych::cor.ci(dat_t |> select(capable_person_e:pressure_parent_teacher_e))
```

```{r}
# self-integrity 
df <- dat_t |> select(capable_person_b:comfortable_who_i_am_b)
get.ordinal.omega(df) # 0.58

df <- dat_t |> select(capable_person_e:comfortable_who_i_am_e)
get.ordinal.omega(df) # 0.72

# self-esteem
df <- dat_t |> select(feel_smart_b:worried_other_think_b)
get.ordinal.omega(df) # 0.61

df <- dat_t |> select(feel_smart_e:worried_other_think_e)
get.ordinal.omega(df) # 0.67

# belonging
df <- dat_t |> select(belong_school_b:ppl_like_me_b)
get.ordinal.omega(df) # 0.55

df <- dat_t |> select(belong_school_e:ppl_like_me_e)
get.ordinal.omega(df) # 0.64

# stereotype
df <- dat_t |> select(worry_abt_dumb_b:worry_ppl_dislike_b)
get.ordinal.omega(df) # 0.73

df <- dat_t |> select(worry_abt_dumb_e:worry_ppl_dislike_e)
get.ordinal.omega(df) # 0.62

# stereotype all items
df <- dat_t |> select(worry_abt_dumb_b:conclusion_abt_me_b)
get.ordinal.omega(df) # 0.81

df <- dat_t |> select(worry_abt_dumb_e:conclusion_abt_me_e)
get.ordinal.omega(df) # 0.81

# academic stress
df <- dat_t |> select(bad_grades_b:pressure_parent_teacher_b)
get.ordinal.omega(df) # 0.82

df <- dat_t |> select(bad_grades_e:pressure_parent_teacher_e)
get.ordinal.omega(df) # 0.84

```

Changing the 5-point scale to 3-point scale improves the omega a bit. Removing the negatively worded items substantially improved reliability. I guess that the negatively phrased items really confused kids. 

```{r}
# self-integrity & self-esteem
df <- dat_t |> select(capable_person_b:worried_other_think_b)
get.ordinal.omega(df) # 0.66

df <- dat_t |> select(capable_person_e:worried_other_think_e)
get.ordinal.omega(df) # 0.75

## removing the two items that have the wrong signs (probably because the negative phrasing is too confusing for deaf kids)
df <- dat_t |> select(capable_person_b:worried_other_think_b,
                      -concerned_abt_impression_b,-worried_other_think_b)
get.ordinal.omega(df) # 0.72

df <- dat_t |> select(capable_person_e:worried_other_think_e,
                      -concerned_abt_impression_e,-worried_other_think_e)
get.ordinal.omega(df) # 0.73

# belonging
df <- dat_t |> select(belong_school_b:ppl_like_me_b)
get.ordinal.omega(df) # 0.56

df <- dat_t |> select(belong_school_e:ppl_like_me_e)
get.ordinal.omega(df) # 0.64

## removing the two items that have the wrong signs (probably because the negative phrasing is too confusing for deaf kids)
df <- dat_t |> select(belong_school_b:ppl_like_me_b, 
                      -feel_outsider_b, -teacher_like_me_b)
get.ordinal.omega(df) # 0.68

df <- dat_t |> select(belong_school_e:ppl_like_me_e,
                      -feel_outsider_e, -teacher_like_me_e)
get.ordinal.omega(df) # 0.68

# perceived stereotype
df <- dat_t |> select(worry_abt_dumb_b:worry_ppl_dislike_b, concerned_abt_impression_b,worried_other_think_b)
get.ordinal.omega(df) # 0.79

df <- dat_t |> select(worry_abt_dumb_e:worry_ppl_dislike_e, concerned_abt_impression_e,worried_other_think_e)
get.ordinal.omega(df) # 0.79

# stereotype threat
df <- dat_t |> select(conclusion_other_deaf_b, conclusion_my_perform_b, conclusion_abt_me_b)
get.ordinal.omega(df) # 0.82

df <- dat_t |> select(conclusion_other_deaf_e, conclusion_my_perform_e, conclusion_abt_me_e)
get.ordinal.omega(df) # 0.86
```

## EFA for psychological threat index (raw data)

### Baseline

The following 5 factors emerge from a simple run of EFA (based on both the scree plot and theoretical reasons):

- Academic stress: `bad_grades_b:pressure_parent_teacher_b`
- Stereotype threat: 
  `conclusion_other_deaf_b, conclusion_my_perform_b, conclusion_abt_me_b`,
  `worry_ppl_dislike_b, worried_other_think_b, worry_abt_dumb_b`,
- `respect_lookup_b, people_accept_b, capable_person_b, feel_smart_b, belong_school_b`
- `comfortable_at_school_b, comfortable_who_i_am_b, confident_abt_future_b`
- `ppl_like_me_b, nervous_worried_b`

**Dropping the following items:** `teacher_like_me_b, concerned_abt_impression_b, feel_outsider_b`

I also tried the k-fold factor analysis, which suggests a 3-factor structure. This also makes sense: f1 - self-esteem and social evaluative threat, f2 - stereotype threat, f3 - academic threat.

`f1 =~ capable_person_b + confident_abt_future_b + comfortable_who_i_am_b + feel_smart_b + respect_lookup_b + belong_school_b + people_accept_b + comfortable_at_school_b`

`f2 =~ worried_other_think_b + worry_abt_dumb_b + nervous_worried_b + worry_ppl_dislike_b + conclusion_other_deaf_b + conclusion_my_perform_b + conclusion_abt_me_b`

`f3 =~ bad_grades_b + not_understand_class_b + not_understand_homework_b + bad_class_teacher_b + trouble_studying_b + pressure_parent_teacher_b`

```{r}
# baseline
efa_b <- psych::fa(dat |> select(capable_person_b:pressure_parent_teacher_b, -teacher_like_me_b, -concerned_abt_impression_b, -feel_outsider_b, -ppl_like_me_b                              ), 3)

n_factors <- length(efa_b$e.values)
scree     <- data.frame(
  Factor_n =  as.factor(1:n_factors), 
  Eigenvalue = efa_b$e.values)
ggplot(scree, aes(x = Factor_n, y = Eigenvalue, group = 1)) + 
  geom_point() + geom_line() +
  xlab("Number of factors") +
  ylab("Initial eigenvalue") +
  labs( title = "Scree Plot", 
        subtitle = "(Based on the unreduced correlation matrix)")


pdf("analysis/plots/efa_b_diagram.pdf", height=30, width=15)
psych::fa.diagram(efa_b)
dev.off()


# try kfa
# need to remove weird items first

dat_kfa_b <- dat |> select(capable_person_b:pressure_parent_teacher_b,
       -teacher_like_me_b, -concerned_abt_impression_b, -feel_outsider_b, -ppl_like_me_b)
       
kfa_b <- kfa(dat_kfa_b,
             k = NULL,
             m = 6,
             seed = 1234)

kfa_report(models = kfa_b,
           file.name = "analysis/kfa_report_baseline",
           report.title = "K-fold Factor Analysis - Baseline",
           report.format = "html_document")

```

### Endline

The same three factor model in endline also yields the best CFA fit. Reliability is lower but still acceptable.

```{r}
# endline
efa_e <- psych::fa(dat |> select(capable_person_e:pressure_parent_teacher_e, -teacher_like_me_e, -concerned_abt_impression_e, -feel_outsider_e, -ppl_like_me_e                              ), 3)

n_factors <- length(efa_e$e.values)
scree     <- data.frame(
  Factor_n =  as.factor(1:n_factors), 
  Eigenvalue = efa_e$e.values)
ggplot(scree, aes(x = Factor_n, y = Eigenvalue, group = 1)) + 
  geom_point() + geom_line() +
  xlab("Number of factors") +
  ylab("Initial eigenvalue") +
  labs( title = "Scree Plot", 
        subtitle = "(Based on the unreduced correlation matrix)")


pdf("analysis/plots/efa_e_diagram.pdf", height=30, width=15)
psych::fa.diagram(efa_e)
dev.off()


# try kfa
# need to remove weird items first

dat_kfa_e <- dat |> select(capable_person_e:pressure_parent_teacher_e,
       -teacher_like_me_e, -concerned_abt_impression_e, -feel_outsider_e, -ppl_like_me_e)
       
kfa_e <- kfa(dat_kfa_e,
             k = NULL,
             m = 6,
             seed = 1234)

kfa_report(models = kfa_e,
           file.name = "analysis/kfa_report_endine",
           report.title = "K-fold Factor Analysis - Endline",
           report.format = "html_document")
```


# Frequentist HLM model for survey outcomes (as pre-registered)

This is having problems with fit and convergence, potentially because the model is too complicated. I will use a fully Bayesian method that both regularizes the model via informative priors and gives estimates and credible intervals for all parameters that average over the uncertainty in the random effects parameters (Gelman and Hill 2006, McElreath 2015; MCMCglmm, rstanarm and brms packages).

```{r}
fit <- with(data = dat_f_r_mi, exp = lmer(f_self_integrity_esteem_e ~ f_self_integrity_esteem_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id)))

fit <-  lmer(f_self_integrity_esteem_e ~ f_self_integrity_esteem_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id), data = dat_s)
```

# Bayesian HLM models for survey outcomes

**MLM rationales:**

I will choose multilevel modeling over latent growth curve under an SEM framework. 

The outcome variables are repeatedly measured at two time points, so the time points are technically nested in individual students. And because students are nested in classrooms, I can incorporate this nested structure in a three-level multilevel model.

https://en.wikipedia.org/wiki/Multilevel_modeling_for_repeated_measures#Multilevel_Modeling_versus_Structural_Equation_Modeling_(SEM;_Latent_Growth_Model)

The potential issue is that the items are also nested in individuals. But for repeated measures, wouldn't the items be nested in time? So the MLM becomes four-level?? This is way too complex.

Or maybe I can also use the factor scores as predictors and outcomes.

Also, only random intercept model is available in lavaan.

Ref: 
https://glennwilliams.me/r4psych/mixed-effects-models.html
<Ordinal Regression Models in Psychology: A Tutorial>
https://www-ncbi-nlm-nih-gov.proxy.library.nyu.edu/pmc/articles/PMC5965529/

## Continuous outcomes (Multiple imputation on transformed data)

```{r}
library(brms)
# library(mice)

dat_s <- dat_t |> filter(!is.na(treated_int))

dat_s <- dat_s |> 
  rowwise() |> 
  mutate(
    # self integrity and self-esteem
    self_integrity_esteem_b = mean(c(capable_person_b, confident_abt_future_b, comfortable_who_i_am_b, feel_smart_b, respect_lookup_b), na.rm = T),
    self_integrity_esteem_e = mean(c(capable_person_e, confident_abt_future_e, comfortable_who_i_am_e, feel_smart_e, respect_lookup_e), na.rm = T),
    
    # belonging
    belonging_b = mean(c(belong_school_b, people_accept_b, comfortable_at_school_b, ppl_like_me_b), na.rm = T),
    belonging_e = mean(c(belong_school_e, people_accept_e, comfortable_at_school_e, ppl_like_me_e), na.rm = T),
    
    # perceived stereotype and stereotype threat
    worry_b = mean(c(worry_abt_dumb_b, nervous_worried_b, worry_ppl_dislike_b, concerned_abt_impression_b,worried_other_think_b), na.rm = T),
    worry_e = mean(c(worry_abt_dumb_e, nervous_worried_e, worry_ppl_dislike_e,concerned_abt_impression_e,worried_other_think_e), na.rm = T),
    stereotype_b = mean(c(conclusion_other_deaf_b, conclusion_my_perform_b, conclusion_abt_me_b), na.rm = T),
    stereotype_e = mean(c( conclusion_other_deaf_e, conclusion_my_perform_e, conclusion_abt_me_e), na.rm = T),
    
    conclusion_other_deaf_b, conclusion_my_perform_b, conclusion_abt_me_b,
    conclusion_other_deaf_e, conclusion_my_perform_e, conclusion_abt_me_e,
    
    # academic stress
    academic_stress_b = mean(c(bad_grades_b, not_understand_class_b,not_understand_homework_b, bad_class_teacher_b, trouble_studying_b, pressure_parent_teacher_b), na.rm = T),
    academic_stress_e = mean(c(bad_grades_e, not_understand_class_e,not_understand_homework_e, bad_class_teacher_e, trouble_studying_e, pressure_parent_teacher_e), na.rm = T)
    )

# scale within each classroom
dat_s <- dat_s |> 
  group_by(class_id) |> 
  mutate_at(vars(self_integrity_esteem_b:academic_stress_e), function(x){as.numeric(scale(x))})

dat_s <- dat_s |> select(
  st_id, grade, class_id, class_size, gender, age_b, student_type, father_edu_f, mother_edu_f,
    father_occ_salary, mother_occ_salary, adult_members,
  siblings, treated_int, duration_int, mc_survey_1_int:mc_survey_4_int,
  self_integrity_esteem_b, self_integrity_esteem_e,
  belonging_b, belonging_e,
  worry_b, worry_e,
  stereotype_b, stereotype_e,
  conclusion_other_deaf_b, conclusion_my_perform_b, conclusion_abt_me_b,
    conclusion_other_deaf_e, conclusion_my_perform_e, conclusion_abt_me_e,
  academic_stress_b, academic_stress_e)
  
dat_mi <- mice::mice(dat_s, m = 5, seed = 1234)
```

```{r}
# set prior according to Wu et al., 2021
# Treatment effect on secondary outcome (adjusted for covariates): normal(0.17183, 0.06211)
# Treatment effect on primary outcome (adjusted for covariates): normal(0.20643, 0.05516)

fit_integrity_esteem <- brm_multiple(
  self_integrity_esteem_e ~ self_integrity_esteem_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi,
  prior = set_prior("normal(0, 0.05)", class = "b", coef = "treated_int"), 
  #prior = set_prior("student_t(3, 0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)


fit_belonging <- brm_multiple(
  belonging_e ~ belonging_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi,
  prior = set_prior("normal(0, 0.05)", class = "b", coef = "treated_int"), 
  #prior = set_prior("student_t(3, 0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)

fit_worry <- brm_multiple(
  worry_e ~ worry_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi,
  prior = set_prior("normal(0, 0.05)", class = "b", coef = "treated_int"), 
  #prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)

fit_stereotype <- brm_multiple(
  stereotype_e ~ stereotype_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi,
  #prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  prior = set_prior("normal(0, 0.05)", class = "b", coef = "treated_int"), 
  chains = 4,
  seed = 1234
)

fit_conclusion_other_deaf <- brm_multiple(
  conclusion_other_deaf_e ~ conclusion_other_deaf_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi,
  prior = set_prior("normal(0, 0.05)", class = "b", coef = "treated_int"), 
  #prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)

fit_conclusion_my_perform <- brm_multiple(
  conclusion_my_perform_e ~ conclusion_my_perform_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi,
  prior = set_prior("normal(0, 0.05)", class = "b", coef = "treated_int"),
  #prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)

fit_conclusion_abt_me <- brm_multiple(
  conclusion_abt_me_e ~ conclusion_abt_me_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi,
  prior = set_prior("normal(0, 0.05)", class = "b", coef = "treated_int"),
  #prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)

fit_academic_stress <- brm_multiple(
  academic_stress_e ~ academic_stress_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi,
  prior = set_prior("normal(0, 0.05)", class = "b", coef = "treated_int"),
  #prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)


# https://discourse.mc-stan.org/t/brm-multiple-not-converging-though-separate-brm-models-do/8740/2

# fit_integrity_esteem$rhats
# prior_summary(fit_integrity_esteem)
summary(fit_integrity_esteem)
summary(fit_belonging)
summary(fit_stereotype)
summary(fit_worry)
summary(fit_academic_stress)


hypothesis(fit_integrity_esteem, "treated_int > 0") # BF = 1.32; PP = 0.57
hypothesis(fit_belonging, "treated_int > 0") # BF = 0.31; PP = 0.24
hypothesis(fit_stereotype, "treated_int < 0") # BF = 2.65; PP = 0.73
hypothesis(fit_worry, "treated_int < 0") # BF = 8.2; PP = 0.89
hypothesis(fit_academic_stress, "treated_int < 0") # 1.78; PP = 0.64

hypothesis(fit_conclusion_other_deaf, "treated_int < 0") # BF = 6.39; PP = 0.86
hypothesis(fit_conclusion_my_perform, "treated_int < 0") # BF = 3.34; PP = 0.77
hypothesis(fit_conclusion_abt_me, "treated_int < 0") # BF = 5.8; PP = 0.85

# plot(fit, pars = "treated_int")
```

```{r}
dat_s_deaf <- dat_s |> filter(student_type == "Deaf")
dat_mi_deaf <- mice::mice(dat_s_deaf, m = 5, seed = 1234)
```

```{r}
# set prior according to past meta-analysis

fit_integrity_esteem_deaf <- brm_multiple(
  self_integrity_esteem_e ~ self_integrity_esteem_b + treated_int +
    class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi_deaf,
  #prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  prior = set_prior("student_t(3, 0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)


fit_belonging_deaf <- brm_multiple(
  belonging_e ~ belonging_b + treated_int +
    class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi_deaf,
  #prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  prior = set_prior("student_t(3, 0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)

fit_worry_deaf <- brm_multiple(
  worry_e ~ worry_b + treated_int +
    class_size + grade + gender + age_b +  father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi_deaf,
  #prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)

fit_stereotype_deaf <- brm_multiple(
  stereotype_e ~ stereotype_b + treated_int +
    class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi_deaf,
  prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  #prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  chains = 4,
  seed = 1234
)

fit_conclusion_other_deaf_deaf <- brm_multiple(
  conclusion_other_deaf_e ~ conclusion_other_deaf_b + treated_int +
    class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi_deaf,
  #prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)

fit_conclusion_my_perform_deaf <- brm_multiple(
  conclusion_my_perform_e ~ conclusion_my_perform_b + treated_int +
    class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi_deaf,
  #prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)

fit_conclusion_abt_me_deaf <- brm_multiple(
  conclusion_abt_me_e ~ conclusion_abt_me_b + treated_int +
    class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi_deaf,
  #prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)

fit_academic_stress_deaf <- brm_multiple(
  academic_stress_e ~ academic_stress_b + treated_int +
    class_size + grade + gender + age_b + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_mi_deaf,
  #prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"),
  prior = set_prior("student_t(3, -0.18, 0.2)", class = "b", coef = "treated_int"),
  chains = 4,
  seed = 1234
)


# https://discourse.mc-stan.org/t/brm-multiple-not-converging-though-separate-brm-models-do/8740/2

# fit_integrity_esteem$rhats
# prior_summary(fit_integrity_esteem)
summary(fit_integrity_esteem_deaf)
summary(fit_belonging_deaf)
summary(fit_stereotype_deaf)
summary(fit_worry_deaf)
summary(fit_academic_stress_deaf)


hypothesis(fit_integrity_esteem_deaf, "treated_int > 0") # BF = 1.19; PP = 0.54
hypothesis(fit_belonging_deaf, "treated_int > 0") # BF = 0.35; PP = 0.26
hypothesis(fit_stereotype_deaf, "treated_int < 0") # BF = 1.996; PP = 0.66
hypothesis(fit_worry_deaf, "treated_int < 0") # BF = 2.23; PP = 0.69
hypothesis(fit_academic_stress_deaf, "treated_int < 0") # 3.89; PP = 0.8

hypothesis(fit_conclusion_other_deaf_deaf, "treated_int < 0") # BF = 13.68; PP = 0.93
hypothesis(fit_conclusion_my_perform_deaf, "treated_int < 0") # BF = 3.16; PP = 0.76
hypothesis(fit_conclusion_abt_me_deaf, "treated_int < 0") # BF = 13.04; PP = 0.93

# plot(fit, pars = "treated_int")
```


## Change scores as ordinal outcomes?

The reliability of the change scores is not good. Maybe this is not a good idea.

https://statisticalhorizons.com/wp-content/uploads/Allison.SM90.pdf

```{r}
dat_s <- dat_t |> filter(!is.na(treated_int))

dat_s <- dat_s |> 
  mutate(
    capable_person_diff= capable_person_e - capable_person_b,
    confident_abt_future_diff= confident_abt_future_e - confident_abt_future_b,
    comfortable_who_i_am_diff= comfortable_who_i_am_e - comfortable_who_i_am_b,
    feel_smart_diff= feel_smart_e - feel_smart_b,
    concerned_abt_impression_diff= concerned_abt_impression_e - concerned_abt_impression_b,
    respect_lookup_diff= respect_lookup_e - respect_lookup_b,
    worried_other_think_diff= worried_other_think_e - worried_other_think_b,
    belong_school_diff= belong_school_e - belong_school_b,
    people_accept_diff= people_accept_e - people_accept_b,
    feel_outsider_diff= feel_outsider_e - feel_outsider_b,
    teacher_like_me_diff= teacher_like_me_e - teacher_like_me_b,
    comfortable_at_school_diff= comfortable_at_school_e - comfortable_at_school_b,
    ppl_like_me_diff= ppl_like_me_e - ppl_like_me_b,
    worry_abt_dumb_diff= worry_abt_dumb_e - worry_abt_dumb_b,
    nervous_worried_diff= nervous_worried_e - nervous_worried_b,
    worry_ppl_dislike_diff= worry_ppl_dislike_e - worry_ppl_dislike_b,
    conclusion_other_deaf_diff= conclusion_other_deaf_e - conclusion_other_deaf_b,
    conclusion_my_perform_diff= conclusion_my_perform_e - conclusion_my_perform_b,
    conclusion_abt_me_diff= conclusion_abt_me_e - conclusion_abt_me_b,
    bad_grades_diff= bad_grades_e - bad_grades_b,
    not_understand_class_diff= not_understand_class_e - not_understand_class_b,
    not_understand_homework_diff= not_understand_homework_e - not_understand_homework_b,
    bad_class_teacher_diff= bad_class_teacher_e - bad_class_teacher_b,
    trouble_studying_diff= trouble_studying_e - trouble_studying_b,
    pressure_parent_teacher_diff= pressure_parent_teacher_e - pressure_parent_teacher_b
  )

dat_s <- dat_s |> select(
  st_id, grade, class_id, class_size, gender, age_b, student_type, father_edu_f, mother_edu_f,
    father_occ_salary, mother_occ_salary, adult_members,
  siblings, treated_int, duration_int, mc_survey_1_int:mc_survey_4_int,
  capable_person_diff:pressure_parent_teacher_diff)
```

```{r}
# self-integrity & self-esteem
df <- dat_s |> select(capable_person_diff:worried_other_think_diff,
                      -concerned_abt_impression_diff,-worried_other_think_diff)
get.ordinal.omega(df) # 0.59

# belonging
df <- dat_s |> select(belong_school_diff:ppl_like_me_diff,
                      -feel_outsider_diff, -teacher_like_me_diff)
get.ordinal.omega(df) # 0.57

# stereotype all items
df <- dat_s |> select(worry_abt_dumb_diff:conclusion_abt_me_diff)
get.ordinal.omega(df) # 0.69

# academic stress
df <- dat_s |> select(bad_grades_diff:pressure_parent_teacher_diff)
get.ordinal.omega(df) # 0.72

```

## Factor scores as outcomes (Multiple imputation on transformed data; original scale)

```{r}
dat_s <- dat_t |> mutate(
  
  f_self_integrity_esteem_b = psych::fa(dat_t |>
                              select(capable_person_b:worried_other_think_b,
                    -concerned_abt_impression_b,-worried_other_think_b), 
                    1, cor = "poly", oblique.scores = T)$scores[,1],
  
  f_self_integrity_esteem_e = psych::fa(dat_t |>
                              select(capable_person_e:worried_other_think_e,
                    -concerned_abt_impression_e,-worried_other_think_e), 
                    1, cor = "poly", oblique.scores = T)$scores[,1],
  
  f_belonging_b = psych::fa(dat_t |> select(belong_school_b:ppl_like_me_b, 
                      -feel_outsider_b, -teacher_like_me_b), 
                    1, cor = "poly", oblique.scores = T)$scores[,1],
  
  f_belonging_e = psych::fa(dat_t |> select(belong_school_e:ppl_like_me_e, 
                      -feel_outsider_e, -teacher_like_me_e), 
                    1, cor = "poly", oblique.scores = T)$scores[,1],
  
  f_stereotype_b = psych::fa(dat_t |>
                              select(worry_abt_dumb_b:conclusion_abt_me_b), 
                    1, cor = "poly", oblique.scores = T)$scores[,1],
  
  f_stereotype_e = psych::fa(dat_t |>
                               select(worry_abt_dumb_e:conclusion_abt_me_e), 
                    1, cor = "poly", oblique.scores = T)$scores[,1],
  
  f_academic_stress_b = psych::fa(dat_t |>
                              select(bad_grades_b:pressure_parent_teacher_b), 
                    1, cor = "poly", oblique.scores = T)$scores[,1],
  
  f_academic_stress_e = psych::fa(dat_t |>
                               select(bad_grades_e:pressure_parent_teacher_e), 
                    1, cor = "poly", oblique.scores = T)$scores[,1]
)


dat_s <- dat_s |> filter(!is.na(treated_int))


dat_s <- dat_s |> select(
  st_id, grade, class_id, class_size, gender, age_b, student_type, father_edu_f, mother_edu_f,
    father_occ_salary, mother_occ_salary, adult_members,
  siblings, treated_int, duration_int, mc_survey_1_int:mc_survey_4_int,
  f_self_integrity_esteem_b, f_self_integrity_esteem_e,
  f_belonging_b, f_belonging_e,
  f_stereotype_b, f_stereotype_e,
  f_academic_stress_b, f_academic_stress_e)

# scale within each classroom
dat_s <- dat_s |> 
  group_by(class_id) |> 
  mutate_at(vars(f_self_integrity_esteem_b:f_academic_stress_e), function(x){as.numeric(scale(x))})
  
dat_f_mi <- mice::mice(dat_s, m = 5, seed = 1234)
```

```{r}
# set prior according to past meta-analysis

fit_f_integrity_esteem <- brm_multiple(
  f_self_integrity_esteem_e ~ f_self_integrity_esteem_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_f_mi,
  prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  chains = 4,
  seed = 1234
)


fit_f_belonging <- brm_multiple(
  f_belonging_e ~ f_belonging_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_f_mi,
  prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  chains = 4,
  seed = 1234
)

fit_f_stereotype <- brm_multiple(
  f_stereotype_e ~ f_stereotype_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_f_mi,
  prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  chains = 4,
  seed = 1234
)

fit_f_academic_stress <- brm_multiple(
  f_academic_stress_e ~ f_academic_stress_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_f_mi,
  prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  chains = 4,
  seed = 1234
)


# https://discourse.mc-stan.org/t/brm-multiple-not-converging-though-separate-brm-models-do/8740/2

# fit_integrity_esteem$rhats
# prior_summary(fit_integrity_esteem)
summary(fit_f_integrity_esteem)
summary(fit_f_belonging)
summary(fit_f_stereotype)
summary(fit_f_academic_stress)

# plot(fit, pars = "treated_int")
```

## Factor scores as outcomes (Multiple imputation on raw data; original scale)

```{r}
dat_s <- dat |> mutate(
  
  f_self_integrity_esteem_b = psych::fa(dat |>
                              select(capable_person_b:worried_other_think_b,
                    -concerned_abt_impression_b,-worried_other_think_b), 
                    1, scores = "tenBerge", oblique.scores = T)$scores[,1],
  
  f_self_integrity_esteem_e = psych::fa(dat |>
                              select(capable_person_e:worried_other_think_e,
                    -concerned_abt_impression_e,-worried_other_think_e), 
                    1, scores = "tenBerge", oblique.scores = T)$scores[,1],
  
  f_belonging_b = psych::fa(dat |> select(belong_school_b:ppl_like_me_b, 
                      -feel_outsider_b, -teacher_like_me_b), 
                    1, scores = "tenBerge", oblique.scores = T)$scores[,1],
  
  f_belonging_e = psych::fa(dat |> select(belong_school_e:ppl_like_me_e, 
                      -feel_outsider_e, -teacher_like_me_e), 
                    1, scores = "tenBerge", oblique.scores = T)$scores[,1],
  
  f_stereotype_b = psych::fa(dat |>
                              select(worry_abt_dumb_b:conclusion_abt_me_b), 
                    1, scores = "tenBerge", oblique.scores = T)$scores[,1],
  
  f_stereotype_e = psych::fa(dat |>
                               select(worry_abt_dumb_e:conclusion_abt_me_e), 
                    1, scores = "tenBerge", oblique.scores = T)$scores[,1],
  
  f_academic_stress_b = psych::fa(dat |>
                              select(bad_grades_b:pressure_parent_teacher_b), 
                    1, scores = "tenBerge", oblique.scores = T)$scores[,1],
  
  f_academic_stress_e = psych::fa(dat |>
                               select(bad_grades_e:pressure_parent_teacher_e), 
                    1, scores = "tenBerge", oblique.scores = T)$scores[,1]
)


dat_s <- dat_s |> filter(!is.na(treated_int))


dat_s <- dat_s |> select(
  st_id, grade, class_id, class_size, gender, age_b, student_type, father_edu_f, mother_edu_f,
    father_occ_salary, mother_occ_salary, adult_members,
  siblings, treated_int, duration_int, mc_survey_1_int:mc_survey_4_int,
  f_self_integrity_esteem_b, f_self_integrity_esteem_e,
  f_belonging_b, f_belonging_e,
  f_stereotype_b, f_stereotype_e,
  f_academic_stress_b, f_academic_stress_e)

# scale within each classroom
dat_s <- dat_s |> 
  group_by(class_id) |> 
  mutate_at(vars(f_self_integrity_esteem_b:f_academic_stress_e), function(x){as.numeric(scale(x))})
  
dat_f_r_mi <- mice::mice(dat_s, m = 5, seed = 1234)
```

```{r}
# set prior according to past meta-analysis

fit_f_r_integrity_esteem <- brm_multiple(
  f_self_integrity_esteem_e ~ f_self_integrity_esteem_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_f_r_mi,
  prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  chains = 4,
  seed = 1234
)


fit_f_r_belonging <- brm_multiple(
  f_belonging_e ~ f_belonging_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_f_r_mi,
  prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  chains = 4,
  seed = 1234
)

fit_f_r_stereotype <- brm_multiple(
  f_stereotype_e ~ f_stereotype_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_f_r_mi,
  prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  chains = 4,
  seed = 1234
)

fit_f_r_academic_stress <- brm_multiple(
  f_academic_stress_e ~ f_academic_stress_b + treated_int +
    class_size + grade + gender + age_b + student_type + father_edu_f + mother_edu_f +
    father_occ_salary + mother_occ_salary + adult_members + siblings + duration_int +
    (treated_int | class_id),
  dat_f_r_mi,
  prior = set_prior("normal(0.145, 0.5)", class = "b", coef = "treated_int"), 
  chains = 4,
  seed = 1234
)


# https://discourse.mc-stan.org/t/brm-multiple-not-converging-though-separate-brm-models-do/8740/2

# fit_integrity_esteem$rhats
# prior_summary(fit_integrity_esteem)
summary(fit_f_r_integrity_esteem)
summary(fit_f_r_belonging)
summary(fit_f_r_stereotype)
summary(fit_f_r_academic_stress)

# plot(fit, pars = "treated_int")
```

## Factor scores as outcomes (Multiple imputation on transformed data; kfa-validated constructs)

### Baseline

```{r}
var_b <- c("capable_person_b" , "confident_abt_future_b" , "comfortable_who_i_am_b" , "feel_smart_b" , "respect_lookup_b" , "belong_school_b" , "people_accept_b" , "comfortable_at_school_b",

   "worried_other_think_b" , "worry_abt_dumb_b" , "nervous_worried_b" , "worry_ppl_dislike_b" , "conclusion_other_deaf_b" , "conclusion_my_perform_b" , "conclusion_abt_me_b",

   "bad_grades_b" , "not_understand_class_b" , "not_understand_homework_b" , "bad_class_teacher_b" , "trouble_studying_b" , "pressure_parent_teacher_b") 

model_cfa_b <- 
'
  # latent variable
  
  f1 =~ capable_person_b + confident_abt_future_b + comfortable_who_i_am_b + feel_smart_b + respect_lookup_b + belong_school_b + people_accept_b + comfortable_at_school_b
  
  f2 =~ worried_other_think_b + worry_abt_dumb_b + nervous_worried_b + worry_ppl_dislike_b + conclusion_other_deaf_b + conclusion_my_perform_b + conclusion_abt_me_b
  
  f3 =~ bad_grades_b + not_understand_class_b + not_understand_homework_b + bad_class_teacher_b + trouble_studying_b + pressure_parent_teacher_b
  
  # residual covariance
  conclusion_other_deaf_b ~~ conclusion_my_perform_b + conclusion_abt_me_b
  conclusion_my_perform_b ~~ conclusion_abt_me_b

  comfortable_who_i_am_b ~~   comfortable_at_school_b
  confident_abt_future_b ~~    comfortable_who_i_am_b
  respect_lookup_b ~~           people_accept_b
  not_understand_class_b ~~       bad_class_teacher_b
'

# only one 1 in this variable, collapsing that to 2
test <- dat |> mutate(people_accept_b = recode(people_accept_b, `1` = 2))

fit_cfa_b <- lavaan::cfa(model_cfa_b,
                         data = test,
                         ordered = var_b)

summary(fit_cfa_b, fit.measures = TRUE, standardized = TRUE)

# modindices(fit_cfa_b) |> filter(mi > 3.84 & op == "~~") |> arrange(desc(mi))


# bcfa (not using because blavFitIndices are not for ordinal data)

# fit_bcfa_b <- blavaan::bcfa(model_cfa_b,
#                          data = dat_t,
#                          ordered = var_b)
# 
# 
# summary(fit_bcfa_b, fit.measures = TRUE, standardized = TRUE)
# 
#   
# model_bcfa_null_b <- c(paste(var_b, "~~", var_b), paste(var_b, "~ 1"))
#   
# fit_cfa_null_b <- blavaan::bcfa(model_bcfa_null_b,
#                          data = dat_t,
#                          ordered = var_b)
# 
# blavFitIndices(fit_bcfa_b, baseline.model = fit_cfa_null_b)
```



### Endline

```{r}

var_e <- c("capable_person_e" , "confident_abt_future_e" , "comfortable_who_i_am_e" , "feel_smart_e" , "respect_lookup_e" , "belong_school_e" , "people_accept_e" , "comfortable_at_school_e",

   "worried_other_think_e" , "worry_abt_dumb_e" , "nervous_worried_e" , "worry_ppl_dislike_e" , "conclusion_other_deaf_e" , "conclusion_my_perform_e" , "conclusion_abt_me_e",

   "bad_grades_e" , "not_understand_class_e" , "not_understand_homework_e" , "bad_class_teacher_e" , "trouble_studying_e" , "pressure_parent_teacher_e") 

model_cfa_e <- 
"f1 =~ capable_person_e + confident_abt_future_e + comfortable_who_i_am_e + feel_smart_e + respect_lookup_e + belong_school_e + people_accept_e + comfortable_at_school_e

f2 =~ worried_other_think_e + worry_abt_dumb_e + nervous_worried_e + worry_ppl_dislike_e + conclusion_other_deaf_e + conclusion_my_perform_e + conclusion_abt_me_e

f3 =~ bad_grades_e + not_understand_class_e + not_understand_homework_e + bad_class_teacher_e + trouble_studying_e + pressure_parent_teacher_e

worried_other_think_e ~~          worry_abt_dumb_e
conclusion_other_deaf_e ~~   conclusion_my_perform_e
respect_lookup_e ~~          worry_abt_dumb_e
comfortable_who_i_am_e ~~   comfortable_at_school_e

"


fit_cfa_e <- lavaan::cfa(model_cfa_e,
                         data = dat,
                         ordered = var_e)


summary(fit_cfa_e, fit.measures = TRUE, standardized = TRUE)

# modindices(fit_cfa_e) |> filter(mi > 3.84 & op == "~~") |> arrange(desc(mi))
```


# Questions and comments

**Ben:**
- consider brms if I want to do this ordinal (and multilevel)
- maybe a two-stage binary thing in stan model
- use brms to get the model syntax and change it manually; can get more precise estimates of the treatment effect
- `library(report); report(fit_self_integrity)`

**Larry:**

- Consider differential attrition
- Use intent-to-treat
- Stereotype sensitivity sounds more continuous than threats; think about curvilinear relationship
- think about collectistic cultures and how individual and school life merged for these students 
- measurement invariance longitudinal, gender, and age
- age for grade; JADP paper Ha Yeon; predictor of academic performance

**Ha Yeon:**

- Try EFA with all items (minus stereotype.../with or without the stress items) 
- Redefine psychological threats for this unique population
- use kfa package
- recode to three categories; or ordinal models

**Ale:**
- Check alpha sensitive to recoding to three-point scale
- should reinforce self-integrity -> self-esteem/belonging -> less threatened/less stress -> better grades
- check Ale's growth mindset paper
- do factor analysis within theory-based structures

- inverse probability weighted treatment effect; reweight the treatment effect; IPTW may not change the main impact estimates too much
- Lee' bounds 
- Consider MI, go to Jennifer
- https://pubs.aeaweb.org/doi/pdfplus/10.1257/aer.20171112

- Main treatment impact with or without
- bias down the treatment impact

**Jennifer:**

Questions:
- Is transformation to 3 point valid?
- How should I deal with ordinal scale at both waves? How is pivoting to long format compatible with multiple imputation?
- Should I do multiple imputation? How do I deal with missing data?
- How do I deal with kids who did the intervention during the exam period?
- Any forseeable barrier if I use bayesian methods even though I didn't pre-register the analysis that way?

fixed effect school and use factor analysis
multinomial logit
reasonable to impute
google multilevel missing data (mi_longi; ICE package)

ITT 
never takes; Instrumental variables; 
if control too then remove from both sides
present the analysis both ways
Implementation as a chapter in dissertation












